{% load static %}
<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>{{ mapa.nome }} - Editor</title>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <style>
    html, body { height: 100%; }
    * { box-sizing: border-box; }
    body { font-family: system-ui, sans-serif; margin:0; background:#f8fafc; }
    header { background:#111827; color:#fff; padding: .75rem 1rem; display:flex; gap:1rem; align-items:center; }
    header a { color:#93c5fd; text-decoration:none; }
    #map { height: calc(100vh - 56px); }
    .panel { position: fixed; right: 1rem; top: 70px; background:#ffffff; padding: .9rem; border-radius:12px; border:1px solid #e5e7eb; box-shadow:0 8px 24px rgba(0,0,0,.10); width: 320px; z-index: 1000; max-height: calc(100vh - 86px); overflow-y: auto; overflow-x: hidden; }
    .panel h3 { margin:.2rem 0 .8rem; font-size:1.05rem; }
    .panel label { display:block; margin:.25rem 0 .25rem; font-size:.9rem; color:#111827; }
    .panel input, .panel select { width:100%; padding:.45rem .55rem; border:1px solid #d1d5db; border-radius:8px; margin-bottom:.6rem; background:#fff; }
    .panel .row-inline { display:grid; grid-template-columns: 1fr 1fr; gap:.6rem; }
    .panel .row-inline .field { display:flex; flex-direction:column; }
    .panel .actions { position: sticky; bottom: 0; background: linear-gradient(to top, rgba(255,255,255,1), rgba(255,255,255,.96) 60%, rgba(255,255,255,0)); padding-top:.5rem; display:grid; grid-template-columns: 1fr 1fr; gap:.6rem; align-items:center; }
    .panel button { width:100%; padding:.6rem; border:none; border-radius:8px; background:#2563eb; color:#fff; cursor:pointer; font-weight:600; }
    .panel button.secondary { background:#f3f4f6; color:#111827; border:1px solid #e5e7eb; }
    .panel button.secondary:hover { background:#e5e7eb; }
    .panel button:hover { background:#1d4ed8; }
    .msg { margin-top:.5rem; font-size:.9rem; min-height: 1.2rem; }
  </style>
</head>
<body>
  <header>
    <a href="{% url 'map_list' %}">← Meus Mapas</a>
    <div style="flex:1">{{ mapa.nome }}</div>
    <a href="{% url 'bioma_editor' mapa.id %}" style="margin-right:1rem;color:#93c5fd;">Editar Biomas</a>
    <form action="{% url 'logout' %}" method="post" style="display:inline;">
      {% csrf_token %}
      <button type="submit" style="background:none;border:none;color:white;cursor:pointer;text-decoration:underline;padding:0;font-size:1rem;">Sair</button>
    </form>
  </header>

  <div id="map"></div>
  <!-- Modal genérico para criação de Loja/Personagem -->
  <div id="modal-backdrop" style="display:none;position:fixed;inset:0;background:rgba(15,23,42,.45);z-index:1300;align-items:center;justify-content:center;">
    <div id="modal" style="background:#fff;border-radius:12px;box-shadow:0 20px 40px rgba(15,23,42,.4);width:360px;max-width:95vw;max-height:80vh;display:flex;flex-direction:column;">
      <div style="padding:.75rem 1rem;border-bottom:1px solid #e5e7eb;display:flex;align-items:center;justify-content:space-between;">
        <h3 id="modal-title" style="margin:0;font-size:1rem;">Nova entrada</h3>
        <button type="button" id="modal-close" style="border:none;background:transparent;font-size:1.1rem;cursor:pointer;line-height:1;">✕</button>
      </div>
      <div id="modal-body" style="padding:.8rem 1rem;overflow-y:auto;font-size:.9rem;"></div>
      <div style="padding:.7rem 1rem;border-top:1px solid #e5e7eb;display:flex;gap:.6rem;justify-content:flex-end;">
        <button type="button" id="modal-cancel" style="padding:.4rem .85rem;border-radius:8px;border:1px solid #e5e7eb;background:#f3f4f6;cursor:pointer;">Cancelar</button>
        <button type="button" id="modal-save" style="padding:.4rem .95rem;border-radius:8px;border:none;background:#2563eb;color:#fff;font-weight:600;cursor:pointer;">Salvar</button>
      </div>
    </div>
  </div>
  <div class="panel">
    <h3>Novo Assentamento</h3>
    <div class="row-inline">
      <div class="field">
        <label>X</label>
        <input id="pos_x" type="number" step="1" />
      </div>
      <div class="field">
        <label>Y</label>
        <input id="pos_y" type="number" step="1" />
      </div>
    </div>
    <label>Nome</label>
    <input id="nome" type="text" />
    <label>Tipo</label>
    <select id="tipo">
      <option value="V">Vilarejo</option>
      <option value="C">Cidade</option>
      <option value="M">Metrópole</option>
    </select>
    <label>Característica</label>
    <select id="caracteristica">
      <option value="1">Muralhas Fortificadas</option>
      <option value="2" selected>Parques, Jardins e Vegetação Abundante</option>
      <option value="3">Lama, lixo e imundice</option>
      <option value="4">Cemitério extenso</option>
      <option value="5">Nevoeiro Persistente</option>
      <option value="6">Sons e Fumaça de Forjas</option>
      <option value="7">Canais substituem ruas; muitas pontes</option>
      <option value="8">Fronteira com penhasco</option>
      <option value="9">Ruas e construções bem mantidas e limpas</option>
      <option value="10">Ruínas antigas em meio ao assentamento</option>
      <option value="11">Mercado/Bazar com aromas e itens exóticos</option>
      <option value="12">Estrutura impressionante (Castelo, Templo, Círculo, Zigurate)</option>
    </select>
    <label>Fama</label>
    <select id="fama">
      <option value="1" selected>Comida Deliciosa</option>
      <option value="2">População Rude</option>
      <option value="3">População Amigável</option>
      <option value="4">Artistas e Escritores</option>
      <option value="5">Grande Herói/Salvador local</option>
      <option value="6">Flores</option>
      <option value="7">Festival Anual</option>
      <option value="8">Assombrações</option>
      <option value="9">Conjuradores de Magia</option>
      <option value="10">Decadência</option>
      <option value="11">Piedade</option>
      <option value="12">Apostas</option>
      <option value="13">Aversão a Religião</option>
      <option value="14">Educação</option>
      <option value="15">Vinhos/Vinhedos</option>
      <option value="16">Moda/Alta Costura</option>
      <option value="17">Intriga Política</option>
      <option value="18">Guildas Poderosas</option>
      <option value="19">Patriotismo</option>
      <option value="20">Ruínas Antigas</option>
    </select>
    <label>Calamidade</label>
    <select id="calamidade">
      <option value="1" selected>Infestação de Monstros</option>
      <option value="2">Suspeita de assassinato do líder local</option>
      <option value="3">Guerra iminente entre guildas/gangues</option>
      <option value="4">Pragas/Fome provocam rebelião</option>
      <option value="5">Monstros atacam quem entra/saí</option>
      <option value="6">Disputas comerciais criam crise econômica</option>
      <option value="7">Desastre natural ameaça o assentamento</option>
      <option value="8">Profecia terrível assusta moradores</option>
      <option value="9">População em alistamento para guerra</option>
      <option value="10">Violência por intrigas políticas/religiosas</option>
      <option value="11">Assentamento sob cerco</option>
      <option value="12">Escândalo ameaça famílias nobres</option>
    </select>
    <label>Líder</label>
    <select id="lider">
      <option value="1" selected>Líder/Conselho justos e respeitados</option>
      <option value="2">Tirano Temido</option>
      <option value="3">Covarde manipulado por outros</option>
      <option value="4">Líder ilegítimo e rejeitado</option>
      <option value="5">Monstro poderoso</option>
      <option value="6">Conspiradores anônimos misteriosos</option>
      <option value="7">Liderança em disputa aberta e violenta</option>
      <option value="8">Conselho disputado incapaz de decidir</option>
      <option value="9">Líder conhecido por imbecilidade</option>
      <option value="10">Líder moribundo; sucessão disputada</option>
      <option value="11">Mão-de-ferro respeitado</option>
      <option value="12">Líder/Conselho religioso</option>
    </select>
    <label>Bioma (opcional se polígonos definem)</label>
    <select id="bioma_select"><option value="">-- auto --</option></select>
    <div class="actions">
      <button id="randomizar" class="secondary" type="button">Randomizar</button>
      <button id="criar" type="button">Criar</button>
      <div id="msg" class="msg" style="grid-column: 1 / -1;"></div>
    </div>
  </div>

  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script>
    function getCookie(name) {
      const v = document.cookie.match('(^|;)\\s*' + name + '\\s*=\\s*([^;]+)');
      return v ? v.pop() : '';
    }
    const csrftoken = getCookie('csrftoken');

  const imgUrl = '{{ mapa.imagem.url }}';
  const imgWidth = parseInt('{{ mapa.largura|default:"0" }}', 10);
  const imgHeight = parseInt('{{ mapa.altura|default:"0" }}', 10);
  const MAP_ID = parseInt('{{ mapa.id }}', 10);

    const map = L.map('map', { crs: L.CRS.Simple, minZoom: -2 });
    const southWest = map.unproject([0, imgHeight], 0);
    const northEast = map.unproject([imgWidth, 0], 0);
    const bounds = new L.LatLngBounds(southWest, northEast);
    L.imageOverlay(imgUrl, bounds).addTo(map);
    map.fitBounds(bounds);

    // Clique para capturar X/Y
    map.on('click', (e) => {
      const p = map.project(e.latlng, 0);
      document.getElementById('pos_x').value = Math.round(p.x);
      document.getElementById('pos_y').value = Math.round(p.y);
    });

    // Carrega biomas para seleção manual e desenhar polígonos
    fetch(`/api/biomas/?mapa=${MAP_ID}`)
      .then(r=>r.json())
      .then(data => {
        const sel = document.getElementById('bioma_select');
        (data.results || data).forEach(b => {
          const opt = document.createElement('option');
            opt.value = b.id; opt.textContent = `${b.nome} (${b.tipo})`; sel.appendChild(opt);
        });
      });

    let settlementLayerGroup = L.layerGroup().addTo(map);
    // Util: monta HTML de popup de assentamento a partir de um objeto det
    function buildAssentamentoPopup(det){
      const pessoas = (det.personagens || []).slice(0, 3).map(p => p.nome);
      const lojasLista = (det.lojas || []).slice(0, 3);
      const biomas = (det.bioma || []).map(b => b.nome);

      const pessoasHtml = pessoas.length ? pessoas.join(', ') + '…' : '—';
      const lojasHtml = lojasLista.length
        ? lojasLista.map(l => `${l.nome}`).join(', ') + '…'
        : '—';
      const biomasHtml = biomas.length ? biomas.join(', ') : '—';
      return `
        <div style="min-width:220px;font-size:.9rem;">
          <div style="font-weight:600;font-size:1rem;"><a href="#" class="link-detalhe-assentamento" data-assentamento-id="${det.id}" style="color:#1d4ed8;text-decoration:underline;">${det.nome}</a></div>
          <div><strong>Tipo:</strong> ${det.tipo_display || det.tipo}</div>
          <div><strong>Líder:</strong> ${det.lider_display || '—'}</div>
          <div><strong>Fama:</strong> ${det.fama_display || '—'}</div>
          <div><strong>Bioma(s):</strong> ${biomasHtml}</div>
          <div style="margin-top:.35rem;">
            <strong>Pessoas notáveis:</strong> ${pessoasHtml}
          </div>
          <div style="margin-top:.35rem;">
            <strong>Lojas:</strong> ${lojasHtml}
          </div>
          <button
            type="button"
            data-assentamento-id="${det.id}"
            class="btn-criar-loja"
            style="margin-top:.45rem;width:100%;padding:.35rem .5rem;border:none;border-radius:6px;background:#16a34a;color:#fff;cursor:pointer;font-size:.85rem;">
            + Criar loja neste assentamento
          </button>
          <button
            type="button"
            data-assentamento-id="${det.id}"
            class="btn-criar-personagem"
            style="margin-top:.35rem;width:100%;padding:.35rem .5rem;border:none;border-radius:6px;background:#0ea5e9;color:#fff;cursor:pointer;font-size:.85rem;">
            + Criar personagem notável
          </button>
        </div>`;
    }
    function loadSettlements(){
      settlementLayerGroup.clearLayers();
      fetch(`/api/assentamentos/markers/?mapa=${MAP_ID}`)
        .then(r => r.json())
        .then(data => {
          data.forEach(a => {
            if (a.pos_x == null || a.pos_y == null) return;
            const latlng = map.unproject([a.pos_x, a.pos_y], 0);
            const tooltip = `${a.nome} — ${a.tipo_display || a.tipo} (pers.: ${a.personagem_count ?? 0})`;
            const marker = L.marker(latlng).addTo(settlementLayerGroup).bindTooltip(tooltip, {permanent:false});
            marker.on('click', () => {
              // Sempre traz dados frescos do backend para refletir novas lojas/personagens
              fetch(`/api/assentamentos/${a.id}/?t=${Date.now()}`)
                .then(r => r.json())
                .then(det => {
                  const popupHtml = buildAssentamentoPopup(det);
                  marker.bindPopup(popupHtml).openPopup();
                });
            });
          });
        });
    }
    loadSettlements();

    // Toggle de visualização de biomas
    let biomaLayers = {};
    let biomasVisible = false;
    const biomaToggleBtn = document.createElement('button');
    biomaToggleBtn.textContent = 'Mostrar Biomas';
    biomaToggleBtn.style.cssText = 'position:fixed;left:1rem;top:70px;z-index:1100;padding:.55rem .9rem;background:#111827;color:#fff;border:none;border-radius:8px;cursor:pointer;';
    document.body.appendChild(biomaToggleBtn);

    function drawBioma(b){
      if (biomaLayers[b.id]) { biomaLayers[b.id].forEach(l=>map.removeLayer(l)); }
      biomaLayers[b.id] = [];
      (b.poligonos||[]).forEach(polySet => {
        polySet.forEach(poly => {
          const latlngs = poly.map(pt => map.unproject(pt,0));
          const layer = L.polygon(latlngs, {color:b.cor||'#3388ff', weight:1, fillOpacity:0.2});
          biomaLayers[b.id].push(layer);
          if (biomasVisible) layer.addTo(map).bindTooltip(b.nome);
        });
      });
    }

    function setBiomasVisible(visible){
      biomasVisible = visible;
      Object.values(biomaLayers).forEach(arr => arr.forEach(l => { if (visible){ l.addTo(map); } else { map.removeLayer(l); } }));
      biomaToggleBtn.textContent = visible ? 'Ocultar Biomas' : 'Mostrar Biomas';
    }

    biomaToggleBtn.addEventListener('click', () => {
      setBiomasVisible(!biomasVisible);
    });

    // Carrega biomas (após escolher se exibir, adiciona
    fetch(`/api/biomas/?mapa=${MAP_ID}`)
      .then(r=>r.json())
      .then(data => {
        (data.results||data).forEach(drawBioma);
      });

    // Criar novo assentamento
    document.getElementById('criar').addEventListener('click', () => {
      const pos_x = parseFloat(document.getElementById('pos_x').value);
      const pos_y = parseFloat(document.getElementById('pos_y').value);
      const nome = document.getElementById('nome').value.trim();
      const tipo = document.getElementById('tipo').value;
      const caracteristica = document.getElementById('caracteristica').value;
      const fama = document.getElementById('fama').value;
      const calamidade = document.getElementById('calamidade').value;
      const lider = document.getElementById('lider').value;
      const msg = document.getElementById('msg');

      if (!nome || isNaN(pos_x) || isNaN(pos_y)) {
        msg.style.color = '#b91c1c';
        msg.textContent = 'Preencha nome e clique no mapa para X/Y.';
        return;
      }

      const biomaId = document.getElementById('bioma_select').value;
      const payload = { nome, tipo, caracteristica, fama, calamidade, lider, pos_x, pos_y, mapa: MAP_ID };
      if (biomaId) {
        // backend espera lista M2M -> só conseguimos setar após criar se quisermos REST puro;
        // alternativa simples: enviar um campo custom e tratar depois (não implementado agora)
        payload._bioma_ids = [parseInt(biomaId,10)];
      }
      fetch('/api/assentamentos/', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
        body: JSON.stringify(payload)
      })
      .then(r => r.json().then(j => [r.ok, j]))
      .then(([ok, data]) => {
        if (!ok) throw new Error(typeof data === 'string' ? data : JSON.stringify(data));
        msg.style.color = '#065f46';
        msg.textContent = 'Assentamento criado!';
        const latlng = map.unproject([data.pos_x, data.pos_y], 0);
        L.marker(latlng).addTo(settlementLayerGroup).bindTooltip(`${data.nome}`, {permanent:false});
        document.getElementById('nome').value = '';
        loadSettlements(); // recarrega para atualizar contagens/biomas
      })
      .catch(err => {
        msg.style.color = '#b91c1c';
        msg.textContent = 'Erro: ' + err.message;
      });
    });

    // Randomizar campos (exceto Nome e X/Y)
    function randomizeSelect(id, { excludeEmpty=true } = {}){
      const el = document.getElementById(id);
      if (!el) return;
      const options = Array.from(el.options).filter(o => !o.disabled && !o.hidden && (!excludeEmpty || o.value !== ''));
      if (options.length === 0) return;
      const choice = options[Math.floor(Math.random() * options.length)];
      el.value = choice.value;
    }

    document.getElementById('randomizar').addEventListener('click', () => {
      randomizeSelect('tipo');
      randomizeSelect('caracteristica');
      randomizeSelect('fama');
      randomizeSelect('calamidade');
      randomizeSelect('lider');
      // Não alteramos bioma para manter comportamento de auto-atribuição por polígonos
      const msg = document.getElementById('msg');
      msg.style.color = '#374151';
      msg.textContent = 'Campos aleatórios selecionados.';
    });

    // ---- Modal helpers ----
    const modalBackdrop = document.getElementById('modal-backdrop');
    const modalBody = document.getElementById('modal-body');
    const modalTitle = document.getElementById('modal-title');
    const modalClose = document.getElementById('modal-close');
    const modalCancel = document.getElementById('modal-cancel');
    const modalSave = document.getElementById('modal-save');

    let currentModalContext = null; // { type: 'loja'|'personagem'|'detalhe-assentamento'|'detalhe-personagem'|'detalhe-loja', assentamentoId?, personagemId?, lojaId?, popup? }
    let assentamentosCache = null; // cache simples dos assentamentos deste mapa

    function openModal({ title, bodyHtml, context }){
      modalTitle.textContent = title;
      modalBody.innerHTML = bodyHtml;
      currentModalContext = context;
      modalBackdrop.style.display = 'flex';
    }

    function closeModal(){
      modalBackdrop.style.display = 'none';
      modalBody.innerHTML = '';
      currentModalContext = null;
    }

    modalClose.addEventListener('click', closeModal);
    modalCancel.addEventListener('click', closeModal);
    modalBackdrop.addEventListener('click', (e) => {
      if (e.target === modalBackdrop) closeModal();
    });

    // Cliques dentro do corpo do modal (detalhes de assentamento -> loja/personagem)
    modalBody.addEventListener('click', (evt) => {
      const pessoaEl = evt.target.closest('.item-pessoa');
      if (pessoaEl) {
        const personagemId = pessoaEl.getAttribute('data-personagem-id');
        if (!personagemId) return;

        const renderPersonagemModal = (p, assentamentosLista) => {
            const optionsOrigem = (assentamentosLista || []).map(a => `
              <option value="${a.id}" ${p.origem === a.id ? 'selected' : ''}>${a.nome}</option>
            `).join('');

            const bodyHtml = `
              <div style="display:flex;flex-direction:column;gap:.35rem;">
                <div><strong>Nome:</strong> <span id="per-view-nome">${p.nome}</span></div>
                <div><strong>Raça:</strong> <span id="per-view-raca">${p.raca}</span></div>
                <div><strong>Origem:</strong> <span id="per-view-origem">${p.origem_nome || p.origem}</span></div>
                <div><strong>Aparência:</strong> <span id="per-view-aparencia">${p.aparencia_display || p.aparencia}</span></div>
                <div><strong>Segredo:</strong> <span id="per-view-segredo">${p.segredo_display || p.segredo}</span></div>

                <div id="per-edit-container" style="margin-top:.75rem;display:none;flex-direction:column;gap:.35rem;">
                  <label>Nome</label>
                  <input id="edit-per-nome" type="text" value="${p.nome}" style="width:100%;padding:.4rem .5rem;border:1px solid #d1d5db;border-radius:8px;" />
                  <label>Raça</label>
                  <input id="edit-per-raca" type="text" value="${p.raca}" style="width:100%;padding:.4rem .5rem;border:1px solid #d1d5db;border-radius:8px;" />
                  <label>Origem (assentamento)</label>
                  <select id="edit-per-origem" style="width:100%;padding:.4rem .5rem;border:1px solid #d1d5db;border-radius:8px;">
                    ${optionsOrigem}
                  </select>
                  <label>Aparência</label>
                  <select id="edit-per-aparencia" style="width:100%;padding:.4rem .5rem;border:1px solid #d1d5db;border-radius:8px;">
                    <option value="1" ${p.aparencia === '1' ? 'selected' : ''}>Ostenta Joias Diferenciadas</option>
                    <option value="2" ${p.aparencia === '2' ? 'selected' : ''}>Roupas Diferenciadas (Chamativas, Estrangeiras, Formais ou Trapos)</option>
                    <option value="3" ${p.aparencia === '3' ? 'selected' : ''}>Dispositivo Auxiliar de Marcha elegante (Bengala, cadeira de rodas/flutuante, tala/exoesqueleto)</option>
                    <option value="4" ${p.aparencia === '4' ? 'selected' : ''}>Cicatriz Marcante</option>
                    <option value="5" ${p.aparencia === '5' ? 'selected' : ''}>Olhos de cor incomum (ou de 2 cores diferentes)</option>
                    <option value="6" ${p.aparencia === '6' ? 'selected' : ''}>Tatuagens/Piercings</option>
                    <option value="7" ${p.aparencia === '7' ? 'selected' : ''}>Marca de Nascença</option>
                    <option value="8" ${p.aparencia === '8' ? 'selected' : ''}>Cabelos de cor incomum</option>
                    <option value="9" ${p.aparencia === '9' ? 'selected' : ''}>Careca OU Barba/Cabelo trançado</option>
                    <option value="10" ${p.aparencia === '10' ? 'selected' : ''}>Nariz distinto (grande/pequeno ou quebrado ou bulboso)</option>
                    <option value="11" ${p.aparencia === '11' ? 'selected' : ''}>Postura distinta (Encurvado ou Rígido)</option>
                    <option value="12" ${p.aparencia === '12' ? 'selected' : ''}>Extremamente belo/feio</option>
                  </select>
                  <label>Segredo</label>
                  <select id="edit-per-segredo" style="width:100%;padding:.4rem .5rem;border:1px solid #d1d5db;border-radius:8px;">
                    <option value="1" ${p.segredo === '1' ? 'selected' : ''}>Disfarçado, ocultando identidade ou aspecto específico da aparência</option>
                    <option value="2" ${p.segredo === '2' ? 'selected' : ''}>Planejando/Executando/Escondendo um crime</option>
                    <option value="3" ${p.segredo === '3' ? 'selected' : ''}>Esta pessoa ou a família dela foi ameaçada de morte caso deixe de fazer algo</option>
                    <option value="4" ${p.segredo === '4' ? 'selected' : ''}>Magicamente influenciada a se comportar de determinada forma</option>
                    <option value="5" ${p.segredo === '5' ? 'selected' : ''}>Terrivelmente doente ou acometido por dor crônica</option>
                    <option value="6" ${p.segredo === '6' ? 'selected' : ''}>Se sente responsável pela morte/infortúnio de alguém</option>
                    <option value="7" ${p.segredo === '7' ? 'selected' : ''}>Prestes a falir catastroficamente</option>
                    <option value="8" ${p.segredo === '8' ? 'selected' : ''}>Desesperadamente carente ou nutrindo paixão não correspondida</option>
                    <option value="9" ${p.segredo === '9' ? 'selected' : ''}>Nutrindo uma ambição poderosa</option>
                    <option value="10" ${p.segredo === '10' ? 'selected' : ''}>Profundamente insatisfeito/deprimido</option>
                  </select>
                  <button type="button" id="per-btn-randomizar" style="margin-top:.4rem;align-self:flex-start;padding:.25rem .6rem;border-radius:6px;border:1px solid #d1d5db;background:#e5e7eb;cursor:pointer;font-size:.8rem;">Randomizar características</button>
                </div>

                <button type="button" id="per-btn-editar" style="margin-top:.75rem;align-self:flex-start;padding:.3rem .7rem;border-radius:6px;border:1px solid #d1d5db;background:#f3f4f6;cursor:pointer;font-size:.85rem;">Editar</button>
              </div>`;

            openModal({
              title: `Personagem: ${p.nome}`,
              bodyHtml,
              context: { type: 'detalhe-personagem', personagemId: parseInt(personagemId, 10) }
            });

            // Ativa modo edição ao clicar em "Editar"
            const btnEditar = document.getElementById('per-btn-editar');
            if (btnEditar) {
              btnEditar.addEventListener('click', () => {
                const editBox = document.getElementById('per-edit-container');
                if (!editBox) return;
                editBox.style.display = 'flex';
              });
            }

            // Randomizar características (origem, aparência, segredo) no modo edição
            const btnRand = document.getElementById('per-btn-randomizar');
            if (btnRand) {
              btnRand.addEventListener('click', () => {
                const origemSel = document.getElementById('edit-per-origem');
                const aparSel = document.getElementById('edit-per-aparencia');
                const segSel = document.getElementById('edit-per-segredo');

                const randomizeSelect = (el) => {
                  if (!el) return;
                  const opts = Array.from(el.options).filter(o => !o.disabled);
                  if (!opts.length) return;
                  const choice = opts[Math.floor(Math.random() * opts.length)];
                  el.value = choice.value;
                };

                randomizeSelect(origemSel);
                randomizeSelect(aparSel);
                randomizeSelect(segSel);
              });
            }
        };

        const carregarPersonagem = () => {
          fetch(`/api/personagens/${personagemId}/?t=${Date.now()}`)
            .then(r => r.json())
            .then(p => {
              renderPersonagemModal(p, assentamentosCache || []);
            });
        };

        if (assentamentosCache) {
          carregarPersonagem();
        } else {
          fetch(`/api/assentamentos/?mapa=${MAP_ID}`)
            .then(r => r.json())
            .then(data => {
              assentamentosCache = data.results || data;
              carregarPersonagem();
            });
        }
        return;
      }

      const lojaEl = evt.target.closest('.item-loja');
      if (lojaEl) {
        const lojaId = lojaEl.getAttribute('data-loja-id');
        if (!lojaId) return;

        fetch(`/api/lojas/${lojaId}/?t=${Date.now()}`)
          .then(r => r.json())
          .then(l => {
            const bodyHtml = `
              <div style="display:flex;flex-direction:column;gap:.35rem;">
                <div><strong>Nome:</strong> ${l.nome}</div>
                <div><strong>Tipo (código):</strong> ${l.tipo}</div>
                <div><strong>Lojista (id):</strong> ${l.lojista || '—'}</div>
                <div><strong>Assentamento (id):</strong> ${l.assentamento || '—'}</div>
                <div><strong>Catálogo:</strong></div>
                <div style="white-space:pre-wrap;font-size:.85rem;">${l.catalogo || ''}</div>
              </div>`;

            openModal({
              title: `Loja: ${l.nome}`,
              bodyHtml,
              context: { type: 'detalhe-loja', lojaId: parseInt(lojaId, 10) }
            });
          });
      }
    });

    // Delegação de clique para botões de criar loja/personagem no popup
    map.on('popupopen', (e) => {
      const container = e.popup.getElement();
      if (!container) return;

      container.onclick = (evt) => {
        // Abrir detalhes completos do assentamento
        const linkAssentamento = evt.target.closest('.link-detalhe-assentamento');
        if (linkAssentamento) {
          evt.preventDefault();
          const assentamentoId = linkAssentamento.getAttribute('data-assentamento-id');
          if (!assentamentoId) return;

          fetch(`/api/assentamentos/${assentamentoId}/?t=${Date.now()}`)
            .then(r => r.json())
            .then(det => {
              const biomas = (det.bioma || []).map(b => b.nome).join(', ') || '—';
              const pessoasList = (det.personagens || []);
              const lojasList = (det.lojas || []);
              const descricao = det.descricao || '';

              const pessoasHtml = pessoasList.length
                ? pessoasList.map(p => `
                    <div class=\"item-pessoa\" data-personagem-id=\"${p.id}\" style=\"padding:.1rem 0;cursor:pointer;\">
                      <span style=\"margin-right:.25rem;\">•</span>
                      <span class=\"link-item\" style=\"color:#1d4ed8;text-decoration:underline;\">${p.nome}</span>
                    </div>
                  `).join('')
                : '<div style=\"color:#6b7280;\">—</div>';
              const lojasHtml = lojasList.length
                ? lojasList.map(l => `
                    <div class=\"item-loja\" data-loja-id=\"${l.id}\" style=\"padding:.1rem 0;cursor:pointer;\">
                      <span style=\"margin-right:.25rem;\">•</span>
                      <span class=\"link-item\" style=\"color:#1d4ed8;text-decoration:underline;\">${l.nome}</span>
                    </div>
                  `).join('')
                : '<div style=\"color:#6b7280;\">—</div>';

              const bodyHtml = `
                <div style="display:grid;grid-template-columns:1.5fr 1fr;gap:.75rem;align-items:flex-start;">
                  <div style="display:flex;flex-direction:column;gap:.25rem;">
                    <div><strong>Nome:</strong> ${det.nome}</div>
                    <div><strong>Tipo:</strong> ${det.tipo_display || det.tipo}</div>
                    <div><strong>Bioma(s):</strong> ${biomas}</div>
                    <div><strong>Característica:</strong> ${det.caracteristica || '—'}</div>
                    <div><strong>Fama:</strong> ${det.fama_display || det.fama || '—'}</div>
                    <div><strong>Calamidade:</strong> ${det.calamidade || '—'}</div>
                    <div><strong>Líder:</strong> ${det.lider_display || det.lider || '—'}</div>
                    <div><strong>Posição X,Y:</strong> ${det.pos_x ?? '—'}, ${det.pos_y ?? '—'}</div>
                  </div>
                  <div style="display:flex;flex-direction:column;gap:.5rem;">
                    <div>
                      <div><strong>Pessoas notáveis</strong></div>
                      <div style="max-height:120px;overflow-y:auto;font-size:.85rem;margin-top:.15rem;">
                        ${pessoasHtml}
                      </div>
                    </div>
                    <div>
                      <div><strong>Lojas</strong></div>
                      <div style="max-height:120px;overflow-y:auto;font-size:.85rem;margin-top:.15rem;">
                        ${lojasHtml}
                      </div>
                    </div>
                  </div>
                </div>
                <div style="margin-top:.6rem;">
                  <label for="assentamento-descricao"><strong>Descrição detalhada</strong></label>
                  <textarea id="assentamento-descricao" rows="4" style="width:100%;padding:.4rem .5rem;border:1px solid #d1d5db;border-radius:8px;resize:vertical;">${descricao}</textarea>
                </div>`;

              openModal({
                title: `Detalhes de ${det.nome}`,
                bodyHtml,
                context: { type: 'detalhe-assentamento', assentamentoId: parseInt(assentamentoId, 10) }
              });
            });
          return;
        }

        // Criar loja
        const btnLoja = evt.target.closest('.btn-criar-loja');
        if (btnLoja) {
          const assentamentoId = btnLoja.getAttribute('data-assentamento-id');
          if (!assentamentoId) return;

          const bodyHtml = `
            <label>Nome da loja</label>
            <input id="loj-nome" type="text" style="width:100%;padding:.4rem .5rem;border:1px solid #d1d5db;border-radius:8px;margin-bottom:.5rem;" />
            <label>Tipo de loja</label>
            <select id="loj-tipo" style="width:100%;padding:.4rem .5rem;border:1px solid #d1d5db;border-radius:8px;margin-bottom:.5rem;">
              <option value="1">Penhora</option>
              <option value="2">Apotecário</option>
              <option value="3">Mercearia</option>
              <option value="4">Iguarias Finas/Exóticas</option>
              <option value="5">Olaria</option>
              <option value="6">Funerária</option>
              <option value="7">Livraria</option>
              <option value="8">Banco</option>
              <option value="9">Armoraria</option>
              <option value="10">Velas e Incensos</option>
              <option value="11">Forja/Oficina</option>
              <option value="12">Carpintaria</option>
              <option value="13" selected>Ateliê</option>
              <option value="14">Joalheria</option>
              <option value="15">Padaria</option>
              <option value="16">Cartógrafo</option>
              <option value="17">Alfaiate</option>
              <option value="18">Cordoaria</option>
              <option value="19">Construtora</option>
              <option value="20">Biblioteca</option>
            </select>
            <label>Catálogo (opcional)</label>
            <textarea id="loj-catalogo" rows="4" style="width:100%;padding:.4rem .5rem;border:1px solid #d1d5db;border-radius:8px;resize:vertical;"></textarea>
          `;

          openModal({
            title: 'Nova loja',
            bodyHtml,
            context: { type: 'loja', assentamentoId: parseInt(assentamentoId, 10), popup: e.popup }
          });
          return;
        }

        // Criar personagem
        const btnPersonagem = evt.target.closest('.btn-criar-personagem');
        if (btnPersonagem) {
          const assentamentoId = btnPersonagem.getAttribute('data-assentamento-id');
          if (!assentamentoId) return;

          const bodyHtml = `
            <label>Nome do personagem</label>
            <input id="per-nome" type="text" style="width:100%;padding:.4rem .5rem;border:1px solid #d1d5db;border-radius:8px;margin-bottom:.5rem;" />
            <label>Raça</label>
            <input id="per-raca" type="text" style="width:100%;padding:.4rem .5rem;border:1px solid #d1d5db;border-radius:8px;margin-bottom:.5rem;" />
            <label>Aparência</label>
            <select id="per-aparencia" style="width:100%;padding:.4rem .5rem;border:1px solid #d1d5db;border-radius:8px;margin-bottom:.5rem;">
              <option value="1">Ostenta Joias Diferenciadas</option>
              <option value="2">Roupas Diferenciadas (Chamativas, Estrangeiras, Formais ou Trapos)</option>
              <option value="3">Dispositivo Auxiliar de Marcha elegante (Bengala, cadeira de rodas/flutuante, tala/exoesqueleto)</option>
              <option value="4">Cicatriz Marcante</option>
              <option value="5">Olhos de cor incomum (ou de 2 cores diferentes)</option>
              <option value="6">Tatuagens/Piercings</option>
              <option value="7">Marca de Nascença</option>
              <option value="8">Cabelos de cor incomum</option>
              <option value="9">Careca OU Barba/Cabelo trançado</option>
              <option value="10">Nariz distinto (grande/pequeno ou quebrado ou bulboso)</option>
              <option value="11">Postura distinta (Encurvado ou Rígido)</option>
              <option value="12">Extremamente belo/feio</option>
            </select>
            <label>Segredo</label>
            <select id="per-segredo" style="width:100%;padding:.4rem .5rem;border:1px solid #d1d5db;border-radius:8px;margin-bottom:.5rem;">
              <option value="1">Disfarçado, ocultando identidade ou aspecto específico da aparência</option>
              <option value="2">Planejando/Executando/Escondendo um crime</option>
              <option value="3">Esta pessoa ou a família dela foi ameaçada de morte caso deixe de fazer algo</option>
              <option value="4">Magicamente influenciada a se comportar de determinada forma</option>
              <option value="5">Terrivelmente doente ou acometido por dor crônica</option>
              <option value="6">Se sente responsável pela morte/infortúnio de alguém</option>
              <option value="7">Prestes a falir catastroficamente</option>
              <option value="8">Desesperadamente carente ou nutrindo paixão não correspondida</option>
              <option value="9">Nutrindo uma ambição poderosa</option>
              <option value="10">Profundamente insatisfeito/deprimido</option>
            </select>
            <button type="button" id="per-btn-randomizar-criacao" style="margin-top:.25rem;align-self:flex-start;padding:.25rem .6rem;border-radius:6px;border:1px solid #d1d5db;background:#e5e7eb;cursor:pointer;font-size:.8rem;">Randomizar características</button>
          `;

          openModal({
            title: 'Novo personagem notável',
            bodyHtml,
            context: { type: 'personagem', assentamentoId: parseInt(assentamentoId, 10), popup: e.popup }
          });

          // Ativa randomização na criação (aparência/segredo) após o modal abrir
          setTimeout(() => {
            const btnRandCriacao = document.getElementById('per-btn-randomizar-criacao');
            if (btnRandCriacao) {
              btnRandCriacao.addEventListener('click', () => {
                const aparSel = document.getElementById('per-aparencia');
                const segSel = document.getElementById('per-segredo');

                const randomizeSelect = (el) => {
                  if (!el) return;
                  const opts = Array.from(el.options).filter(o => !o.disabled);
                  if (!opts.length) return;
                  const choice = opts[Math.floor(Math.random() * opts.length)];
                  el.value = choice.value;
                };

                randomizeSelect(aparSel);
                randomizeSelect(segSel);
              });
            }
          }, 0);
        }
      };
    });

    // Salvar do modal (Loja / Personagem / Detalhes)
    modalSave.addEventListener('click', () => {
      if (!currentModalContext) return;
      const { type, assentamentoId, personagemId, lojaId, popup } = currentModalContext;

      if (type === 'loja') {
        const nome = (document.getElementById('loj-nome') || {}).value?.trim();
        const tipo = (document.getElementById('loj-tipo') || {}).value;
        const catalogo = (document.getElementById('loj-catalogo') || {}).value || '';
        if (!nome) return;

        const payload = {
          nome,
          tipo,
          lojista: null,
          catalogo,
          assentamento: assentamentoId
        };

        fetch('/api/lojas/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
          body: JSON.stringify(payload)
        })
        .then(r => r.json().then(j => [r.ok, j]))
        .then(([ok, data]) => {
          if (!ok) throw new Error(typeof data === 'string' ? data : JSON.stringify(data));
          // Recarrega dados do assentamento e reaplica template do popup
          return fetch(`/api/assentamentos/${assentamentoId}/?t=${Date.now()}`).then(r => r.json());
        })
        .then(det => {
          const html = buildAssentamentoPopup(det);
          popup.setContent(html).update();
          closeModal();
        })
        .catch(err => {
          alert('Erro ao criar loja: ' + err.message);
        });
      }

      if (type === 'personagem') {
        const nome = (document.getElementById('per-nome') || {}).value?.trim();
        const raca = (document.getElementById('per-raca') || {}).value?.trim() || 'Humano';
        const aparencia = (document.getElementById('per-aparencia') || {}).value || '1';
        const segredo = (document.getElementById('per-segredo') || {}).value || '1';
        if (!nome) return;

        const payload = {
          nome,
          raca,
          origem: assentamentoId,
          aparencia,
          segredo
        };

        fetch('/api/personagens/', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
          body: JSON.stringify(payload)
        })
        .then(r => r.json().then(j => [r.ok, j]))
        .then(([ok, data]) => {
          if (!ok) throw new Error(typeof data === 'string' ? data : JSON.stringify(data));
          return fetch(`/api/assentamentos/${assentamentoId}/?t=${Date.now()}`).then(r => r.json());
        })
        .then(det => {
          const html = buildAssentamentoPopup(det);
          popup.setContent(html).update();
          closeModal();
        })
        .catch(err => {
          alert('Erro ao criar personagem: ' + err.message);
        });
      }

      if (type === 'detalhe-personagem') {
        const nome = (document.getElementById('edit-per-nome') || {}).value?.trim();
        const raca = (document.getElementById('edit-per-raca') || {}).value?.trim();
        const origem = (document.getElementById('edit-per-origem') || {}).value;
        const aparencia = (document.getElementById('edit-per-aparencia') || {}).value;
        const segredo = (document.getElementById('edit-per-segredo') || {}).value;
        if (!nome) return;

        const payload = { nome, raca, aparencia, segredo };
        if (origem) {
          payload.origem = parseInt(origem, 10);
        }

        fetch(`/api/personagens/${personagemId}/`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
          body: JSON.stringify(payload)
        })
        .then(r => r.json().then(j => [r.ok, j]))
        .then(([ok, data]) => {
          if (!ok) throw new Error(typeof data === 'string' ? data : JSON.stringify(data));
          closeModal();
        })
        .catch(err => {
          alert('Erro ao salvar personagem: ' + err.message);
        });
      }

      if (type === 'detalhe-assentamento') {
        const descricaoEl = document.getElementById('assentamento-descricao');
        const descricao = descricaoEl ? descricaoEl.value : '';

        fetch(`/api/assentamentos/${assentamentoId}/`, {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json', 'X-CSRFToken': csrftoken },
          body: JSON.stringify({ descricao })
        })
        .then(r => r.json().then(j => [r.ok, j]))
        .then(([ok, data]) => {
          if (!ok) throw new Error(typeof data === 'string' ? data : JSON.stringify(data));
          closeModal();
        })
        .catch(err => {
          alert('Erro ao salvar descrição: ' + err.message);
        });
      }
    });
  </script>
</body>
</html>
